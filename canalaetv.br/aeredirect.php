<?php

  $oldSiteGlobal = 'canalaetv.com.br';

  $newUrl = array(
    'www.aeplay.tv/br/',
    'br.aeplay.tv/ancine',
    'br.aeplay.tv/damien/noticia/hora-morta-o-momento-mais-temido-da-madrugada',
    'br.aeplay.tv/noticias',
    'br.aeplay.tv/entre-em-contato',
    'br.aeplay.tv/onde-assistir',
    'br.aeplay.tv/enquete/{variable}',
    'www.aeplay.tv/br/programas',
    'www.aeplay.tv/br/programas',
    'www.aeplay.tv/br/programas',
    'www.aeplay.tv/br/programas',
    'www.aeplay.tv/br/programas',
    'www.aeplay.tv/br/horarios',
    'www.aeplay.tv/br/horarios',
    'www.aeplay.tv/br/horarios',
    'www.aeplay.tv/br/horarios',
    'www.aeplay.tv/br/horarios',
    'br.aeplay.tv/impresa',
    'br.aeplay.tv/jogos/{variable}',
    'www.aeplay.tv/',
    'br.aeplay.tv/movies/{variable}',
    'br.aeplay.tv/noticias',
    'br.aeplay.tv/noticias/{variable}',
    'br.aeplay.tv/personagem',
    'br.aeplay.tv/personagem/{variable}',
    'br.aeplay.tv/politica-privacidade',
    'br.aeplay.tv/polÃ­tica-remocao',
    'www.aeplay.tv/br/programas',
    'www.aeplay.tv/br/programas',
    'www.aeplay.tv/br/programas',
    'br.aeplay.tv/publicidade',
    'br.aeplay.tv/sobre-o-ae',
    'br.aeplay.tv/serie/{variable}',
    'br.aeplay.tv/termos-uso',
    'www.aeplay.tv/br/',
    'www.aeplay.tv/br/',
    'www.aeplay.tv/br/',
    'www.aeplay.tv/br/',
    'br.aeplay.tv/sobre-o-ae',
    'www.aeplay.tv/br/programas',
    'br.aeplay.tv/entre-em-contato',
    'www.aeplay.tv/br/',
    'www.aeplaytv/br/programas',
    'www.aeplaytv/br/horarios',
    'br.aeplay.tv/microsites/{variable}',
    'www.aeplay.tv/br/serie/filhas-da-poligamia_y8bsko',
    'www.aeplay.tv/br/serie/60-dias-infiltrados-na-prisao_2dd08k',
    'www.aeplay.tv/br/movie/warren-jeffs-profeta-do-mal_bfg1r7',
    'www.aeplay.tv/br/serie/ate-que-a-morte-nos-separe_7jity4',
    'www.aeplay.tv/br/serie/acumuladores-compulsivos_t01cjm',
    'www.aeplay.tv/br/serie/barrados-na-fronteira_e317yp',
    'www.aeplay.tv/br/serie/casos-arquivados_kas6mq',
    'www.aeplay.tv/br/serie/desaparecidos_6mndxd',
    'www.aeplay.tv/br/serie/policia-ao-vivo-melhores-mome_g82q95',
    'br.aeplay.tv/microsites/aeinvestiga/videos/gangues-e-extorsao',
    'br.aeplay.tv/microsites/aeinvestiga/videos/extorsao-termina-em-briga',
    'br.aeplay.tv/microsites/aeinvestiga/videos/mae-atras-das-grades',
    'br.aeplay.tv/microsites/aeinvestiga/videos/mormons-na-cadeia',
    'br.aeplay.tv/microsites/aeinvestiga/videos/pai-e-filho-novatos',
    'www.aeplay.tv/br/',
    'www.aeplay.tv/br/',
    'www.aeplay.tv/br/',
    'www.aeplay.tv/br/',
    'br.aeplay.tv/microsites/sabedoria-oriental/videos/bartitsu--a-arte-marcial-praticada-por-sherlock-holmes',
    'br.aeplay.tv/microsites/sabedoria-oriental/videos/o-japao-esta-ficando-sem-ninjas',
    'www.aeplay.tv/br/'
  );


  $oldUrl = array(
    ''. $oldSiteGlobal .'',
    ''. $oldSiteGlobal .'/ancine-informacoes-de-programacao',
    ''. $oldSiteGlobal .'/damien/noticia/hora-morta-o-momento-mais-temido-da-madrugada',
    ''. $oldSiteGlobal .'/aeextras',
    ''. $oldSiteGlobal .'/contato',
    ''. $oldSiteGlobal .'/content/onde-assistir',
    ''. $oldSiteGlobal .'/enquete/{variable}',
    ''. $oldSiteGlobal .'/episode/',
    ''. $oldSiteGlobal .'/episode/{variable}',
    ''. $oldSiteGlobal .'/episodio/{variable}',
    ''. $oldSiteGlobal .'/etiquetas/',
    ''. $oldSiteGlobal .'/etiquetas/{variable}',
    ''. $oldSiteGlobal .'/horarios-movies/',
    ''. $oldSiteGlobal .'/horarios-movies/{variable}',
    ''. $oldSiteGlobal .'/horarios-programas',
    ''. $oldSiteGlobal .'/horarios-programas/{variable}',
    ''. $oldSiteGlobal .'/horarios-programas/horarios-programas/{variable}',
    ''. $oldSiteGlobal .'/imprensa',
    ''. $oldSiteGlobal .'/jogos/{variable}',
    ''. $oldSiteGlobal .'/movies/',
    ''. $oldSiteGlobal .'/movies/{variable}',
    ''. $oldSiteGlobal .'/noticia/',
    ''. $oldSiteGlobal .'/noticia/{variable}',
    ''. $oldSiteGlobal .'/personagem/',
    ''. $oldSiteGlobal .'/personagem/{variable}',
    ''. $oldSiteGlobal .'/politica-de-privacidade',
    ''. $oldSiteGlobal .'/politica-de-remocao',
    ''. $oldSiteGlobal .'/programas/',
    ''. $oldSiteGlobal .'/programas/episodios/',
    ''. $oldSiteGlobal .'/programas/episodios/{variable}',
    ''. $oldSiteGlobal .'/publicidade',
    ''. $oldSiteGlobal .'/quem_somos',
    ''. $oldSiteGlobal .'/serie/{variable}',
    ''. $oldSiteGlobal .'/termos-de-uso',
    ''. $oldSiteGlobal .'/videos',
    ''. $oldSiteGlobal .'/videos/{variable}',
    'www.'. $oldSiteGlobal .'',
    'play.'. $oldSiteGlobal .'',
    'play.'. $oldSiteGlobal .'/#/aboutus',
    'play.'. $oldSiteGlobal .'/#/featured',
    'play.'. $oldSiteGlobal .'/#/help',
    'play.'. $oldSiteGlobal .'/#/notifications',
    'play.'. $oldSiteGlobal .'/#/shows',
    'play.'. $oldSiteGlobal .'/#/tv-schedule',
    ''. $oldSiteGlobal .'/microsites/{variable}',
    ''. $oldSiteGlobal .'/microsites/aeinvestiga/show/filhas-da-poligamia',
    ''. $oldSiteGlobal .'/microsites/aeinvestiga/show/60-dias-infiltrados-na-prisao',
    ''. $oldSiteGlobal .'/microsites/aeinvestiga/show/warren-jeffs--profeta-do-mal',
    ''. $oldSiteGlobal .'/series/ate-que-morte-nos-separe',
    ''. $oldSiteGlobal .'/serie/acumuladores-compulsivos',
    ''. $oldSiteGlobal .'/serie/barrados-na-fronteira',
    ''. $oldSiteGlobal .'/serie/casos-arquivados',
    ''. $oldSiteGlobal .'/serie/desaparecidos-s2',
    ''. $oldSiteGlobal .'/serie/policia-ao-vivo-melhores-momentos',
    ''. $oldSiteGlobal .'/microsites/aeinvestiga/videos/gangues-e-extorsao',
    ''. $oldSiteGlobal .'/microsites/aeinvestiga/videos/extorsao-termina-em-briga',
    ''. $oldSiteGlobal .'/microsites/aeinvestiga/videos/mae-atras-das-grades',
    ''. $oldSiteGlobal .'/microsites/aeinvestiga/videos/mormons-na-cadeia',
    ''. $oldSiteGlobal .'/microsites/aeinvestiga/videos/pai-e-filho-novatos',
    ''. $oldSiteGlobal .'/microsites/aesocial',
    ''. $oldSiteGlobal .'/microsites/especial-bruce-lee',
    ''. $oldSiteGlobal .'/microsites/especial-de-halloween',
    ''. $oldSiteGlobal .'/inicial',
    ''. $oldSiteGlobal .'/microsites/sabedoria-oriental/videos/bartitsu--a-arte-marcial-praticada-por-sherlock-holmes',
    ''. $oldSiteGlobal .'/microsites/sabedoria-oriental/videos/o-japao-esta-ficando-sem-ninjas',
    ''. $oldSiteGlobal .'/microsites/vamosfalardebullying'
  );

  $exceptions = array(
    $oldSiteGlobal.'/series/ate-que-morte-nos-separe',
    $oldSiteGlobal.'/serie/acumuladores-compulsivos',
    $oldSiteGlobal.'/serie/barrados-na-fronteira',
    $oldSiteGlobal.'/serie/casos-arquivados',
    $oldSiteGlobal.'/serie/desaparecidos-s2',
    $oldSiteGlobal.'/serie/policia-ao-vivo-melhores-momentos',
    $oldSiteGlobal.'/microsites/aeinvestiga/videos/gangues-e-extorsao',
    $oldSiteGlobal.'/microsites/aeinvestiga/videos/extorsao-termina-em-briga',
    $oldSiteGlobal.'/microsites/aeinvestiga/videos/mae-atras-das-grades',
    $oldSiteGlobal.'/microsites/aeinvestiga/videos/mormons-na-cadeia',
    $oldSiteGlobal.'/microsites/aeinvestiga/videos/pai-e-filho-novatos',
    $oldSiteGlobal.'/microsites/aesocial',
    $oldSiteGlobal.'/microsites/especial-bruce-lee',
    $oldSiteGlobal.'/microsites/especial-de-halloween',
    $oldSiteGlobal.'/inicial',
    $oldSiteGlobal.'/microsites/sabedoria-oriental/videos/bartitsu--a-arte-marcial-praticada-por-sherlock-holmes',
    $oldSiteGlobal.'/microsites/sabedoria-oriental/videos/o-japao-esta-ficando-sem-ninjas',
    $oldSiteGlobal.'/microsites/vamosfalardebullying',
    $oldSiteGlobal.'/damien/noticia/hora-morta-o-momento-mais-temido-da-madrugada',
    $oldSiteGlobal.'/microsites/aeinvestiga/show/filhas-da-poligamia',
    $oldSiteGlobal.'/microsites/aeinvestiga/show/60-dias-infiltrados-na-prisao',
    $oldSiteGlobal.'/microsites/aeinvestiga/show/warren-jeffs--profeta-do-mal'
  );

  $countries = array(
    "ar",
    "br",
    "bo",
    "cl",
    "co",
    "cr",
    "do",
    "ec",
    "gt",
    "hn",
    "mx",
    "ni",
    "pa",
    "pe",
    "py",
    "sv",
    "uy",
    "ve"
  );

  $urlsWithVariables = array(
    '/enquete/',
    '/episode/',
    '/episodio/',
    '/etiquetas/',
    '/horarios-movies/',
    '/horarios-programas/',
    '/jogos/',
    '/movies/',
    '/noticia/',
    '/personagem/',
    '/episodios/',
    '/serie/',
    '/series/',
    '/videos/',
    '/episodios/',
    '/microsites/'
  );

  $redirectTo302 = array(
    'movies',
    'serie',
    'microsites'
  );

  function redirectType($url, $urlsWithVariables, $redirectTo302, $exceptions, $countryInUrl){

    $url = removeHtpps($url);
    $url = rtrim($url, "/");

    $urlInParts = explode('/', $url);
    
    $urlParsed = convertUrlException($url, $countryInUrl, $countries);
    if(in_array($urlParsed, $exceptions)):
      return 301;
    endif;

    foreach($urlsWithVariables as $urlsWithVariablesInn){
      $word = str_replace('/', '', $urlsWithVariablesInn);
      $pos = strpos($url, $urlsWithVariablesInn);
      
      if ($pos !== false) {
        if(in_array($word, $redirectTo302)){
          if($urlInParts[1] == $word):
            if(isset($urlInParts[2]) && $urlInParts[2] != ''):
              return 302;
            endif;
          endif;
        }
      }
    }
    return 301;
  }

  function isPlayUrl($url){
    $parts = explode('play.',$url);
    if(sizeof($parts) > 1):
      return true;
    endif;
  }

  function isException($url, $countryInUrl, $exceptions){
    $url = convertUrlException($url, $countryInUrl, $countries);
    $url = removeHtpps($url);

    if (in_array($url, $exceptions)):
      return $url;
    elseif(in_array($url . '/', $exceptions)):
      return $url . '/';
    elseif(in_array(rtrim($url, "/"), $exceptions)):
      return rtrim($url, "/");
    else:
      return false;
    endif;

  }


  function convertUrlException($url, $countryInUrl, $countries){
    if($countryInUrl):
      $url = str_replace($countryInUrl .'.',"{pais}.",$url);
    endif;
    return $url;
  }

  function strposa($haystack, $needles=array(), $offset=0) {
    $chr = array();
    foreach($needles as $needle) {
      $res = strpos($haystack, $needle, $offset);
      if ($res !== false) $chr[$needle] = $res;
    }
    if(empty($chr)) return false;
      
    $parts = explode(key($chr), $haystack);
    return $parts[1];
  }

  function removeHtpps($url){
    $url = str_replace("https://","",$url);
    $url = str_replace("http://","",$url);
    return $url;
  }

  function countryInUrl($url, $countries){
    return 'br';
  }

  function variableInUrl($url, $urlsWithVariables){
    $strposaUrl = strposa($url, $urlsWithVariables, 1);
    if ($strposaUrl):
      if($strposaUrl !== ''):
        return $strposaUrl;
      else:
        return null;
      endif;
    else:
      return null;
    endif;
  }

  function mergeOldUrlAndNewUrl($oldUrl, $newUrl){
    $oldUrl = array_values($oldUrl);
    $newUrl = array_values($newUrl);

    foreach($oldUrl as $key => $oldUrlInd):
      $mergedUrls[] = array('oldUrl' => $oldUrlInd, 'newUrl' => $newUrl[$key]); 
    endforeach;

    return $mergedUrls;
  }

  function existParsedUrlInArrayOldUrl($url, $oldUrl){
    if (in_array($url, $oldUrl)):
      return $url;
    elseif(in_array($url . '/', $oldUrl)):
      return $url . '/';
    elseif(in_array(rtrim($url, "/"), $oldUrl)):
      return rtrim($url, "/");
    else:
      return null;
    endif;
  }

  function matchNewUrl($url, $oldUrl, $newUrl){
    $mergeOldUrlAndNewUrl = mergeOldUrlAndNewUrl($oldUrl, $newUrl);
    foreach($mergeOldUrlAndNewUrl as $mergeOldUrlAndNewUrlInn):
      if($url == $mergeOldUrlAndNewUrlInn['oldUrl']):
        return $mergeOldUrlAndNewUrlInn['newUrl'];
      endif;
    endforeach;
  }

  function convertUrl($url, $countryInUrl, $variableInUrl){
    if($countryInUrl):
      $url = str_replace($countryInUrl .'.',"{pais}.",$url);
    endif;
    if($variableInUrl):
      $url = str_replace($variableInUrl,"{variable}",$url);
    endif;
    return $url;
  }

  function reverseConvertUrl($url, $countryInUrl, $variableInUrl){
    if($countryInUrl):
      $url = str_replace("{pais}",$countryInUrl,$url);
    endif;
    if($variableInUrl):
      $url = str_replace("{variable}",$variableInUrl,$url);
    endif;
    return $url;
  }

  function addHttps($url){
    $url = 'https://' . $url;
    return $url;
  }

  function parseUrl($url, $countryInUrl, $variableInUrl, $oldUrl, $newUrl, $exceptions){

    //Si es una excepcion

    if(isPlayUrl($url)):
      //OJO, LA URL VIENE SIN EL PAIS.
      $url = existParsedUrlInArrayOldUrl($url, $oldUrl);
      $url = matchNewUrl($url, $oldUrl, $newUrl);
      $url = str_replace('{pais}', 'ar',$url);
      $url = addHttps($url);
      return $url;
    endif;


    $isException = isException($url, $countryInUrl, $exceptions);
    if($isException):
      $url = existParsedUrlInArrayOldUrl($url, $oldUrl);
      $url = matchNewUrl($isException, $oldUrl, $newUrl);
      $url = reverseConvertUrl($url, $countryInUrl, $variableInUrl);
      $url = addHttps($url);
      return $url;
    endif;

    //Si no es una excepcion
    $url = convertUrl($url, $countryInUrl, $variableInUrl);
    $url = removeHtpps($url);
    $url = existParsedUrlInArrayOldUrl($url, $oldUrl);
    $url = matchNewUrl($url, $oldUrl, $newUrl);
    if($url == null):
      return null;
    endif;
    $url = reverseConvertUrl($url, $countryInUrl, $variableInUrl);
    //Si la url no esta en el array hay que ver que hacemos

    $url = addHttps($url);

    return $url;
  }

?>
